{% extends 'base.html' %}
{% load static %}

{% block title %}My Goals - TaskForge{% endblock %}

{% block content %}
<!-- Подключаем стилі сторінки цілей -->
<link rel="stylesheet" href="{% static 'css/pages/goals.css' %}?v=8">
<link rel="stylesheet" href="{% static 'css/components/subgoal.css' %}?v=2">

<div class="goals-page">
    <!-- Заголовок сторінки -->
    <div class="page-header">
        <h1>My Goals</h1>
        <p>Track your progress and achieve your dreams</p>
    </div>

    <!-- Статистика цілей -->
    <div class="goals-stats">
        <div class="stat-card">
            <div class="stat-number">{{ total_goals }}</div>
            <div class="stat-label">Total Goals</div>
        </div>
        <div class="stat-card">
            <div class="stat-number">{{ active_goals }}</div>
            <div class="stat-label">Active Goals</div>
        </div>
        <div class="stat-card">
            <div class="stat-number">{{ completed_goals }}</div>
            <div class="stat-label">Completed</div>
        </div>
        <div class="stat-card">
            <div class="stat-number">{{ average_progress }}%</div>
            <div class="stat-label">Avg Progress</div>
        </div>
    </div>

    <!-- Основний контент -->
    <div class="goals-content">
        <!-- Ліва колонка - список цілей -->
        <div class="goals-list-section">
            <div class="section-header">
                <h2>Your Goals</h2>
                <button class="btn-primary" id="create-goal-btn">
                    <i class="fas fa-plus"></i> Create Goal
                </button>
            </div>

            {% if user_goals %}
                <div class="goals-list">
                    {% for goal in user_goals %}
                        <div id="goal-{{ goal.id }}" class="goal-card {% if goal.completed %}completed{% endif %}" data-goal-id="{{ goal.id }}">
                            <div class="goal-header">
                                <h3>{{ goal.name }}</h3>
                                <div class="goal-actions">
                                    <button class="btn-icon delete-goal-btn" data-goal-id="{{ goal.id }}" title="Delete Goal">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                            
                            {% if goal.description %}
                                <p class="goal-description">{{ goal.description }}</p>
                            {% endif %}

                            {% if goal.deadline %}
                                <div class="goal-deadline">
                                    <i class="fas fa-calendar"></i>
                                    Deadline: {{ goal.deadline|date:"F d, Y" }}
                                </div>
                            {% endif %}

                            <!-- Прогресс бар -->
                            <div class="progress-section">
                                <div class="progress-header">
                                    <span>Progress</span>
                                    <span class="progress-percent">{{ goal.get_progress_percent }}%</span>
                                </div>
                                <div class="progress-bar">
                                    <div class="progress-fill" style="width: {{ goal.get_progress_percent }}%"></div>
                                </div>
                            </div>

                            <!-- Підцілі -->
                            {% if goal.subgoals.all %}
                                <div class="subgoals-section">
                                    <h4>Subgoals ({{ goal.get_completed_subgoals_count }}/{{ goal.subgoals.count }})</h4>
                                    <div class="subgoals-list">
                                        {% for subgoal in goal.subgoals.all %}
                                            <div class="subgoal-item {% if subgoal.completed %}completed{% endif %}">
                                                <input type="checkbox" 
                                                       class="subgoal-checkbox" 
                                                       data-subgoal-id="{{ subgoal.id }}"
                                                       data-completed="{{ subgoal.completed|yesno:'true,false' }}"
                                                       {% if subgoal.completed %}checked{% endif %}>
                                                <span class="subgoal-name">{{ subgoal.name }}</span>
                                            </div>
                                        {% endfor %}
                                    </div>
                                </div>
                            {% else %}
                                <div class="no-subgoals">
                                    <p>No subgoals defined for this goal.</p>
                                </div>
                            {% endif %}
                        </div>
                    {% endfor %}
                </div>
            {% else %}
                <div class="empty-state">
                    <div class="empty-icon">
                        <i class="fas fa-bullseye"></i>
                    </div>
                    <h3>No Goals Yet</h3>
                    <p>Start your journey by creating your first goal!</p>
                    <button class="btn-primary" id="create-first-goal-btn">
                        <i class="fas fa-plus"></i> Create Your First Goal
                    </button>
                </div>
            {% endif %}
        </div>

        <!-- Права колонка - створення цілей і шаблони -->
        <div class="goals-sidebar">
            <!-- Форма створення цілі -->
            <div class="create-goal-section" id="create-goal-section" style="display: none;">
                <h3>Create New Goal</h3>
                <form id="create-goal-form">
                    {% csrf_token %}
                    <div class="form-group">
                        <label for="goal-name">Goal Name*</label>
                        <input type="text" id="goal-name" name="name" required placeholder="Enter goal name">
                    </div>
                    
                    <div class="form-group">
                        <label for="goal-description">Description</label>
                        <textarea id="goal-description" name="description" placeholder="Describe your goal..."></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="goal-deadline">Deadline</label>
                        <input type="date" id="goal-deadline" name="deadline">
                    </div>
                    
                    <div class="form-group">
                        <label for="goal-notify">Notify Before (days)</label>
                        <input type="number" id="goal-notify" name="notify_before_days" value="1" min="1" max="30">
                    </div>

                    <!-- Підцілі -->
                    <div class="subgoals-creation">
                        <label>Subgoals</label>
                        <div id="subgoals-list">
                            <div class="subgoal-input">
                                <input type="text" name="subgoal" placeholder="Enter subgoal name">
                                <button type="button" class="btn-icon remove-subgoal">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                        <button type="button" id="add-subgoal-btn" class="btn-secondary">
                            <i class="fas fa-plus"></i> Add Subgoal
                        </button>
                    </div>

                    <div class="form-actions">
                        <button type="button" class="btn-secondary" id="cancel-goal-btn">Cancel</button>
                        <button type="submit" class="btn-primary">Create Goal</button>
                    </div>
                </form>
            </div>

            <!-- Шаблони цілей -->
            {% if goal_templates %}
                <div class="goal-templates-section">
                    <h3>Goal Templates</h3>
                    <p>Quick start with pre-made goals</p>
                    
                    <div class="templates-list">
                        {% for template in goal_templates %}
                            <div class="template-card">
                                <h4>{{ template.name }}</h4>
                                {% if template.description %}
                                    <p>{{ template.description|truncatechars:100 }}</p>
                                {% endif %}
                                <button class="btn-primary use-template-btn" data-template-id="{{ template.id }}">
                                    Use Template
                                </button>
                            </div>
                        {% endfor %}
                    </div>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Модальное вікно підтвердження видалення -->
<div id="delete-modal" class="modal" style="display: none;">
    <div class="modal-content">
        <span class="close">&times;</span>
        <h2>Delete Goal</h2>
        <p>Are you sure you want to delete this goal? This action cannot be undone.</p>
        <div class="modal-actions">
            <button class="btn-secondary" id="cancel-delete">Cancel</button>
            <button class="btn-danger" id="confirm-delete">Delete</button>
        </div>
    </div>
</div>

<!-- Підключаем JavaScript компонентів -->
<script src="{% static 'js/components/modals/base-modal.js' %}"></script>
<script src="{% static 'js/components/modals/dropdown-modal.js' %}"></script>
<script src="{% static 'js/components/subgoal.js' %}"></script>

<!-- Підключаем JavaScript сторінки цілей -->
<script src="{% static 'js/pages/goals.js' %}"></script>
{% endblock %}
